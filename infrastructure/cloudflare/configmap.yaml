# infrastructure/cloudflare/configmap.yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: cloudflared-config
  namespace: cloudflare # Ensure this is deployed to the same namespace as the deployment
data:
  # config.yaml is the name of the file that will be mounted into the pod.
  config.yaml: |
    tunnel: 0f249570-0304-494a-a200-697a6df5bda1
    # The credentials file path within the container.
    credentials-file: /etc/cloudflared/creds/credentials.json
    ingress:
      - hostname: gitlab.blackcat.co.ke
        service: https://traefik.kube-system.svc:443
        originRequest:
          noTLSVerify: true
      - hostname: '*.apps.blackcat.co.ke' # A wildcard for other potential apps
        service: https://traefik.kube-system.svc:443
        originRequest:
          noTLSVerify: true
      # A catch-all to terminate any other requests as the final entry.
      - service: http_status:404
    # For k3s, the default CNI doesn't support network policies. If you add a CNI
    # that does, you might need to add a 'no-tls-verify' line here if you use
    # the default self-signed certs for internal traffic.